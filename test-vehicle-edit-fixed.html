<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø§ØµÙ„Ø§Ø­ Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª Ø§Ù„Ú¯ÙˆÛŒ Ø®ÙˆØ¯Ø±Ùˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #ffffff;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .btn-primary, .btn-success, .btn-warning {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            color: white;
        }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success:hover { background-color: #218838; }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-pending { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš› ØªØ³Øª Ø§ØµÙ„Ø§Ø­ Ù…Ø´Ú©Ù„ Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª Ø§Ù„Ú¯ÙˆÛŒ Ø®ÙˆØ¯Ø±Ùˆ</h1>
        <p>Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ 500 Ø¯Ø± Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ø±Ùˆ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>

        <div class="test-section info">
            <h3>ğŸ“Š ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡</h3>
            <ul>
                <li>âœ… allowedRoutes Ø­Ø§Ù„Ø§ Ø¨Ù‡ ØµÙˆØ±Øª array ÙØ±Ø³ØªØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</li>
                <li>âœ… Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø¨Ø§ parseFloat</li>
                <li>âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† console.log Ø¨Ø±Ø§ÛŒ debug</li>
                <li>âœ… validation Ø¨Ù‡ØªØ± Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø±ÛŒ</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ” ØªØ³Øª 1: Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø§Ø¯Ù…ÛŒÙ†</h3>
            <button class="btn-primary" onclick="testAdminLogin()">ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†</button>
            <div id="loginResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸš› ØªØ³Øª 2: Ø¯Ø±ÛŒØ§ÙØª Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ø±Ùˆ</h3>
            <button class="btn-primary" onclick="testGetVehicleTemplates()">Ø¯Ø±ÛŒØ§ÙØª Ø§Ù„Ú¯ÙˆÙ‡Ø§</button>
            <div id="getTemplatesResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>âœï¸ ØªØ³Øª 3: Ø§Ø¯ÛŒØª Ø§Ù„Ú¯ÙˆÛŒ Ø®ÙˆØ¯Ø±Ùˆ (Ø±ÙˆØ´ Ø¬Ø¯ÛŒØ¯)</h3>
            <p>ØªØ³Øª Ø§Ø¯ÛŒØª Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ùˆ validation Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡</p>
            <button class="btn-success" onclick="testEditVehicleFixed()">ØªØ³Øª Ø§Ø¯ÛŒØª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡</button>
            <div id="editFixedResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ Ù†ØªØ§ÛŒØ¬ Ú©Ù„ÛŒ ØªØ³Øª</h3>
            <div id="overallResults" class="test-result info">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Øª...</div>
        </div>
    </div>

    <script>
        let testResults = {
            login: false,
            getTemplates: false,
            editFixed: false
        };

        async function testAdminLogin() {
            try {
                document.getElementById('loginResult').innerHTML = `
                    <div class="info">â³ Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†...</div>
                `;

                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    }),
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    testResults.login = true;
                    document.getElementById('loginResult').innerHTML = `
                        <div class="success">
                            âœ… ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ† Ù…ÙˆÙÙ‚
                            <div class="code">Admin: ${data.user?.username || 'admin'}</div>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                testResults.login = false;
                document.getElementById('loginResult').innerHTML = `
                    <div class="error">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†: ${error.message}
                    </div>
                `;
            }
            updateOverallResults();
        }

        async function testGetVehicleTemplates() {
            try {
                document.getElementById('getTemplatesResult').innerHTML = `
                    <div class="info">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ø±Ùˆ...</div>
                `;

                const response = await fetch('/api/logistics/vehicle-templates', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (response.ok && data.success && data.data?.length) {
                    testResults.getTemplates = true;
                    const template = data.data[0];
                    document.getElementById('getTemplatesResult').innerHTML = `
                        <div class="success">
                            âœ… Ø¯Ø±ÛŒØ§ÙØª Ø§Ù„Ú¯ÙˆÙ‡Ø§ Ù…ÙˆÙÙ‚ - ${data.data.length} Ø§Ù„Ú¯Ùˆ
                            <div class="code">
Ø§Ù„Ú¯ÙˆÛŒ Ù†Ù…ÙˆÙ†Ù‡:
- Ù†Ø§Ù…: ${template.name}
- Ù†ÙˆØ¹: ${template.vehicleType}
- Ø­Ø¯Ø§Ú©Ø«Ø± ÙˆØ²Ù†: ${template.maxWeightKg} Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…
- Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡: ${template.basePrice} Ø¯ÛŒÙ†Ø§Ø±
- Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù…Ø¬Ø§Ø²: ${Array.isArray(template.allowedRoutes) ? template.allowedRoutes.join(', ') : template.allowedRoutes}
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Ù‡ÛŒÚ† Ø§Ù„Ú¯ÙˆÛŒÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }
            } catch (error) {
                testResults.getTemplates = false;
                document.getElementById('getTemplatesResult').innerHTML = `
                    <div class="error">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ù„Ú¯ÙˆÙ‡Ø§: ${error.message}
                    </div>
                `;
            }
            updateOverallResults();
        }

        async function testEditVehicleFixed() {
            try {
                // Ø§Ø¨ØªØ¯Ø§ Ø§Ù„Ú¯ÙˆÙ‡Ø§ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒÙ…
                const getResponse = await fetch('/api/logistics/vehicle-templates', {
                    credentials: 'include'
                });
                const getData = await getResponse.json();
                
                if (!getData.success || !getData.data?.length) {
                    throw new Error('Ù‡ÛŒÚ† Ø§Ù„Ú¯ÙˆÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¯ÛŒØª ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }
                
                const templateId = getData.data[0].id;
                document.getElementById('editFixedResult').innerHTML = `
                    <div class="info">â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¯ÛŒØª Ø§Ù„Ú¯Ùˆ ${templateId} Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡...</div>
                `;

                // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ format ØµØ­ÛŒØ­
                const editData = {
                    name: "Ø§Ù„Ú¯ÙˆÛŒ ØªØ³Øª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡",
                    nameEn: "Fixed Test Template",
                    vehicleType: "van",
                    maxWeightKg: 1500.50,
                    maxVolumeM3: 8.75,
                    basePrice: 50000.00,
                    pricePerKm: 1250.25,
                    allowedRoutes: ["urban", "interurban"], // Ø­Ø§Ù„Ø§ array Ø§Ø³Øª
                    averageSpeedKmh: 60.00,
                    fuelConsumptionL100km: 8.50,
                    isActive: true
                };

                console.log('ğŸš› [TEST] Sending fixed data:', editData);

                const response = await fetch(`/api/logistics/vehicle-templates/${templateId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(editData),
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    testResults.editFixed = true;
                    document.getElementById('editFixedResult').innerHTML = `
                        <div class="success">
                            âœ… Ø§Ø¯ÛŒØª Ù…ÙˆÙÙ‚! Ø§Ù„Ú¯Ùˆ ${templateId} Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯
                            <div class="code">
Ù†ØªÛŒØ¬Ù‡:
- Ù†Ø§Ù…: ${data.data.name}
- Ø­Ø¯Ø§Ú©Ø«Ø± ÙˆØ²Ù†: ${data.data.maxWeightKg} Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…
- Ø­Ø¯Ø§Ú©Ø«Ø± Ø­Ø¬Ù…: ${data.data.maxVolumeM3} Ù…ØªØ± Ù…Ú©Ø¹Ø¨
- Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡: ${data.data.basePrice} Ø¯ÛŒÙ†Ø§Ø±
- Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù…Ø¬Ø§Ø²: ${data.data.allowedRoutes?.join(', ')}
- Ù…ØµØ±Ù Ø³ÙˆØ®Øª: ${data.data.fuelConsumptionL100km} Ù„ÛŒØªØ±/100Ú©ÛŒÙ„ÙˆÙ…ØªØ±
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                testResults.editFixed = false;
                document.getElementById('editFixedResult').innerHTML = `
                    <div class="error">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¯ÛŒØª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡: ${error.message}
                        <div class="code">Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±: ${error.response || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</div>
                    </div>
                `;
            }
            updateOverallResults();
        }

        function updateOverallResults() {
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            
            let statusText = '';
            let statusClass = '';
            
            if (passedTests === totalTests) {
                statusText = `âœ… Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ (${passedTests}/${totalTests})`;
                statusClass = 'success';
            } else if (passedTests > 0) {
                statusText = `âš ï¸ Ø¨Ø±Ø®ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ (${passedTests}/${totalTests})`;
                statusClass = 'info';
            } else {
                statusText = `âŒ Ù‡ÛŒÚ† ØªØ³ØªÛŒ Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯ (${passedTests}/${totalTests})`;
                statusClass = 'error';
            }
            
            document.getElementById('overallResults').innerHTML = `
                <div class="${statusClass}">
                    <strong>${statusText}</strong><br>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator ${testResults.login ? 'status-success' : 'status-error'}"></span> ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†<br>
                        <span class="status-indicator ${testResults.getTemplates ? 'status-success' : 'status-error'}"></span> Ø¯Ø±ÛŒØ§ÙØª Ø§Ù„Ú¯ÙˆÙ‡Ø§<br>
                        <span class="status-indicator ${testResults.editFixed ? 'status-success' : 'status-error'}"></span> Ø§Ø¯ÛŒØª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
                    </div>
                </div>
            `;
        }

        // Ø´Ø±ÙˆØ¹ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ³Øªâ€ŒÙ‡Ø§
        window.onload = function() {
            setTimeout(() => {
                testAdminLogin();
            }, 1000);
        }
    </script>
</body>
</html>