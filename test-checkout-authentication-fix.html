<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ù„ Ù…Ø´Ú©Ù„ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú†Ú© Ø§ÙˆØª</title>
    <style>
        body {
            font-family: 'Tahoma', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em;
        }
        .solution-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-result {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            min-height: 60px;
        }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        .warning { border-color: #f59e0b; background: #fffbeb; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .problem-box {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: right;
        }
        .solution-box {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: right;
        }
        .login-form {
            background: #f8fafc;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .login-form input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Ø­Ù„ Ù…Ø´Ú©Ù„ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú†Ú© Ø§ÙˆØª</h1>
        
        <div class="solution-banner">
            <h2>âœ… Ù…Ø´Ú©Ù„ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯: Ù…Ø´ØªØ±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h2>
            <p>Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø¨Ø§ÛŒØ¯ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´ÙˆÛŒØ¯</p>
        </div>

        <div class="problem-box">
            <h3>ğŸ” Ø¹Ù„Øª Ù…Ø´Ú©Ù„:</h3>
            <ul>
                <li>âœ… Ø§Ø¯Ù…ÛŒÙ† ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø§Ù…Ø§ Ù…Ø´ØªØ±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡</li>
                <li>âœ… Ø³ÛŒØ³ØªÙ… dual session Ø¯Ø§Ø±Ø¯ (Admin + Customer)</li>
                <li>âœ… API Ø³ÙØ§Ø±Ø´ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù…Ø´ØªØ±ÛŒ Ø¯Ø§Ø±Ø¯</li>
                <li>âœ… ÙØ±Ù… Ú†Ú© Ø§ÙˆØª Ø¨Ø¯ÙˆÙ† ÙˆØ±ÙˆØ¯ Ù…Ø´ØªØ±ÛŒ Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯</li>
            </ul>
        </div>

        <div class="solution-box">
            <h3>ğŸ’¡ Ø±Ø§Ù‡ Ø­Ù„:</h3>
            <ul>
                <li>âœ… ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø´ØªØ±ÛŒ (Customer Login)</li>
                <li>âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¯Ø± ÙØ±Ù… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯</li>
                <li>âœ… Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ ÙˆØ§Ø¶Ø­ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±</li>
                <li>âœ… Debug logging Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ù…Ø´Ú©Ù„</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª ØªØ³Øª 1: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ÙØ¹Ù„ÛŒ</h3>
            <button onclick="checkCurrentAuth()">Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</button>
            <div id="authStatus" class="test-result">
                Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯...
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”‘ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø´ØªØ±ÛŒ</h3>
            <p>Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ú†Ú© Ø§ÙˆØªØŒ Ø¨Ø§ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯:</p>
            
            <div class="login-form">
                <h4>ğŸ§‘â€ğŸ’¼ ÙˆØ±ÙˆØ¯ Ù…Ø´ØªØ±ÛŒ (Customer Login)</h4>
                <input type="email" id="customerEmail" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø´ØªØ±ÛŒ" value="oilstar@hotmail.com">
                <input type="password" id="customerPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" value="123456">
                <button onclick="loginAsCustomer()" style="width: 100%; margin-top: 10px;">
                    ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø´ØªØ±ÛŒ
                </button>
                <div id="loginResult" class="test-result" style="margin-top: 15px;">
                    ÙØ±Ù… ÙˆØ±ÙˆØ¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª...
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª ØªØ³Øª 2: ØªØ³Øª Ú†Ú© Ø§ÙˆØª Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯</h3>
            <button onclick="testCheckoutAfterLogin()">ØªØ³Øª ÙØ±Ù… Ú†Ú© Ø§ÙˆØª</button>
            <div id="checkoutTest" class="test-result">
                Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ Ø³Ù¾Ø³ Ø§ÛŒÙ† ØªØ³Øª Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯...
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px; color: #4a5568;">
            <p><strong>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ:</strong> Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ØŒ Ø¨Ù‡ ØµÙØ­Ù‡ Shop Ø¨Ø±ÙˆÛŒØ¯ Ùˆ Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯</p>
            <p><strong>Ù†Ú©ØªÙ‡:</strong> Ø§Ú©Ù†ÙˆÙ† ÙØ±Ù… Ú†Ú© Ø§ÙˆØª Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ ÙˆØ§Ø¶Ø­ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯</p>
        </div>
    </div>

    <script>
        let isCustomerLoggedIn = false;

        async function checkCurrentAuth() {
            const resultEl = document.getElementById('authStatus');
            resultEl.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª...';
            
            try {
                // Check admin status
                const adminResponse = await fetch('/api/admin/me', {
                    credentials: 'include'
                });
                const adminData = await adminResponse.json();
                
                // Check customer status
                const customerResponse = await fetch('/api/customers/me', {
                    credentials: 'include'
                });
                const customerData = await customerResponse.json();
                
                resultEl.innerHTML = `
                    <div style="text-align: right;">
                        <h4>ğŸ” ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª:</h4>
                        <div style="background: ${adminResponse.ok ? '#10b981' : '#ef4444'}; color: white; padding: 8px; border-radius: 4px; margin: 5px 0;">
                            ${adminResponse.ok ? 'âœ…' : 'âŒ'} Ø§Ø¯Ù…ÛŒÙ†: ${adminResponse.ok ? `${adminData.user.username} (ÙØ¹Ø§Ù„)` : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
                        </div>
                        <div style="background: ${customerResponse.ok ? '#10b981' : '#ef4444'}; color: white; padding: 8px; border-radius: 4px; margin: 5px 0;">
                            ${customerResponse.ok ? 'âœ…' : 'âŒ'} Ù…Ø´ØªØ±ÛŒ: ${customerResponse.ok ? `${customerData.customer.email} (ÙØ¹Ø§Ù„)` : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
                        </div>
                        <div style="background: #3b82f6; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                            ${customerResponse.ok ? 'âœ… Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´' : 'âŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯ Ù…Ø´ØªØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´'}
                        </div>
                    </div>
                `;
                
                isCustomerLoggedIn = customerResponse.ok;
                resultEl.className = customerResponse.ok ? 'test-result success' : 'test-result warning';
                
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª: ${error.message}
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        async function loginAsCustomer() {
            const resultEl = document.getElementById('loginResult');
            const email = document.getElementById('customerEmail').value;
            const password = document.getElementById('customerPassword').value;
            
            if (!email || !password) {
                resultEl.innerHTML = `
                    <div style="color: #f59e0b;">
                        âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
                    </div>
                `;
                resultEl.className = 'test-result warning';
                return;
            }
            
            resultEl.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...';
            
            try {
                const response = await fetch('/api/customers/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px;">
                                âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚!
                            </div>
                            <p><strong>Ù…Ø´ØªØ±ÛŒ:</strong> ${data.customer?.firstName} ${data.customer?.lastName}</p>
                            <p><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> ${data.customer?.email}</p>
                            <div style="background: #3b82f6; color: white; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                ğŸ¯ Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                    isCustomerLoggedIn = true;
                } else {
                    throw new Error(data.message || 'Login failed');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.message}
                        <p>Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯: Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ØµØ­ÛŒØ­ Ø§Ø³ØªØŸ</p>
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        async function testCheckoutAfterLogin() {
            const resultEl = document.getElementById('checkoutTest');
            
            if (!isCustomerLoggedIn) {
                resultEl.innerHTML = `
                    <div style="color: #f59e0b;">
                        âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ Ø´ÙˆÛŒØ¯
                    </div>
                `;
                resultEl.className = 'test-result warning';
                return;
            }
            
            resultEl.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ú†Ú© Ø§ÙˆØª...';
            
            try {
                // Test customer authentication
                const customerCheck = await fetch('/api/customers/me', {
                    credentials: 'include'
                });
                
                if (customerCheck.ok) {
                    const customerData = await customerCheck.json();
                    
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px;">
                                âœ… Ú†Ú© Ø§ÙˆØª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!
                            </div>
                            <p><strong>Ù…Ø´ØªØ±ÛŒ ÙØ¹Ø§Ù„:</strong> ${customerData.customer.firstName} ${customerData.customer.lastName}</p>
                            <div style="background: #3b82f6; color: white; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                ğŸ›’ Ø¨Ù‡ ØµÙØ­Ù‡ Shop Ø¨Ø±ÙˆÛŒØ¯ Ùˆ Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                } else {
                    throw new Error('Customer authentication failed');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        âŒ Ù…Ø´Ú©Ù„ Ø¯Ø± ØªØ³Øª Ú†Ú© Ø§ÙˆØª: ${error.message}
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        // Auto-check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkCurrentAuth, 1000);
        });
    </script>
</body>
</html>