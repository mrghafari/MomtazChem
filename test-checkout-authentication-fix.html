<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حل مشکل احراز هویت چک اوت</title>
    <style>
        body {
            font-family: 'Tahoma', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em;
        }
        .solution-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-result {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            min-height: 60px;
        }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        .warning { border-color: #f59e0b; background: #fffbeb; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .problem-box {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: right;
        }
        .solution-box {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: right;
        }
        .login-form {
            background: #f8fafc;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .login-form input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 حل مشکل احراز هویت چک اوت</h1>
        
        <div class="solution-banner">
            <h2>✅ مشکل شناسایی شد: مشتری وارد نشده است</h2>
            <p>برای ثبت سفارش باید ابتدا وارد حساب کاربری شوید</p>
        </div>

        <div class="problem-box">
            <h3>🔍 علت مشکل:</h3>
            <ul>
                <li>✅ ادمین وارد شده اما مشتری وارد نشده</li>
                <li>✅ سیستم dual session دارد (Admin + Customer)</li>
                <li>✅ API سفارش نیاز به احراز هویت مشتری دارد</li>
                <li>✅ فرم چک اوت بدون ورود مشتری کار نمی‌کند</li>
            </ul>
        </div>

        <div class="solution-box">
            <h3>💡 راه حل:</h3>
            <ul>
                <li>✅ ورود به عنوان مشتری (Customer Login)</li>
                <li>✅ اعتبارسنجی احراز هویت در فرم اضافه شد</li>
                <li>✅ پیام خطای واضح برای کاربر</li>
                <li>✅ Debug logging برای تشخیص مشکل</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🧪 تست 1: بررسی وضعیت احراز هویت فعلی</h3>
            <button onclick="checkCurrentAuth()">بررسی وضعیت فعلی</button>
            <div id="authStatus" class="test-result">
                کلیک کنید تا وضعیت احراز هویت بررسی شود...
            </div>
        </div>

        <div class="test-section">
            <h3>🔑 ورود به عنوان مشتری</h3>
            <p>برای تست چک اوت، با حساب مشتری وارد شوید:</p>
            
            <div class="login-form">
                <h4>🧑‍💼 ورود مشتری (Customer Login)</h4>
                <input type="email" id="customerEmail" placeholder="ایمیل مشتری" value="oilstar@hotmail.com">
                <input type="password" id="customerPassword" placeholder="رمز عبور" value="123456">
                <button onclick="loginAsCustomer()" style="width: 100%; margin-top: 10px;">
                    ورود به عنوان مشتری
                </button>
                <div id="loginResult" class="test-result" style="margin-top: 15px;">
                    فرم ورود آماده است...
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 تست 2: تست چک اوت پس از ورود</h3>
            <button onclick="testCheckoutAfterLogin()">تست فرم چک اوت</button>
            <div id="checkoutTest" class="test-result">
                ابتدا وارد شوید سپس این تست را اجرا کنید...
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px; color: #4a5568;">
            <p><strong>راهنمایی:</strong> پس از ورود موفق، به صفحه Shop بروید و سفارش ثبت کنید</p>
            <p><strong>نکته:</strong> اکنون فرم چک اوت پیام خطای واضح نمایش می‌دهد</p>
        </div>
    </div>

    <script>
        let isCustomerLoggedIn = false;

        async function checkCurrentAuth() {
            const resultEl = document.getElementById('authStatus');
            resultEl.innerHTML = 'در حال بررسی احراز هویت...';
            
            try {
                // Check admin status
                const adminResponse = await fetch('/api/admin/me', {
                    credentials: 'include'
                });
                const adminData = await adminResponse.json();
                
                // Check customer status
                const customerResponse = await fetch('/api/customers/me', {
                    credentials: 'include'
                });
                const customerData = await customerResponse.json();
                
                resultEl.innerHTML = `
                    <div style="text-align: right;">
                        <h4>🔍 وضعیت احراز هویت:</h4>
                        <div style="background: ${adminResponse.ok ? '#10b981' : '#ef4444'}; color: white; padding: 8px; border-radius: 4px; margin: 5px 0;">
                            ${adminResponse.ok ? '✅' : '❌'} ادمین: ${adminResponse.ok ? `${adminData.user.username} (فعال)` : 'غیرفعال'}
                        </div>
                        <div style="background: ${customerResponse.ok ? '#10b981' : '#ef4444'}; color: white; padding: 8px; border-radius: 4px; margin: 5px 0;">
                            ${customerResponse.ok ? '✅' : '❌'} مشتری: ${customerResponse.ok ? `${customerData.customer.email} (فعال)` : 'غیرفعال'}
                        </div>
                        <div style="background: #3b82f6; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                            ${customerResponse.ok ? '✅ آماده برای ثبت سفارش' : '❌ نیاز به ورود مشتری برای ثبت سفارش'}
                        </div>
                    </div>
                `;
                
                isCustomerLoggedIn = customerResponse.ok;
                resultEl.className = customerResponse.ok ? 'test-result success' : 'test-result warning';
                
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        ❌ خطا در بررسی احراز هویت: ${error.message}
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        async function loginAsCustomer() {
            const resultEl = document.getElementById('loginResult');
            const email = document.getElementById('customerEmail').value;
            const password = document.getElementById('customerPassword').value;
            
            if (!email || !password) {
                resultEl.innerHTML = `
                    <div style="color: #f59e0b;">
                        ⚠️ لطفاً ایمیل و رمز عبور را وارد کنید
                    </div>
                `;
                resultEl.className = 'test-result warning';
                return;
            }
            
            resultEl.innerHTML = 'در حال ورود...';
            
            try {
                const response = await fetch('/api/customers/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px;">
                                ✅ ورود موفق!
                            </div>
                            <p><strong>مشتری:</strong> ${data.customer?.firstName} ${data.customer?.lastName}</p>
                            <p><strong>ایمیل:</strong> ${data.customer?.email}</p>
                            <div style="background: #3b82f6; color: white; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                🎯 حالا می‌توانید سفارش ثبت کنید
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                    isCustomerLoggedIn = true;
                } else {
                    throw new Error(data.message || 'Login failed');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        ❌ خطا در ورود: ${error.message}
                        <p>بررسی کنید: ایمیل و رمز عبور صحیح است؟</p>
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        async function testCheckoutAfterLogin() {
            const resultEl = document.getElementById('checkoutTest');
            
            if (!isCustomerLoggedIn) {
                resultEl.innerHTML = `
                    <div style="color: #f59e0b;">
                        ⚠️ ابتدا باید وارد حساب مشتری شوید
                    </div>
                `;
                resultEl.className = 'test-result warning';
                return;
            }
            
            resultEl.innerHTML = 'در حال تست چک اوت...';
            
            try {
                // Test customer authentication
                const customerCheck = await fetch('/api/customers/me', {
                    credentials: 'include'
                });
                
                if (customerCheck.ok) {
                    const customerData = await customerCheck.json();
                    
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px;">
                                ✅ چک اوت آماده است!
                            </div>
                            <p><strong>مشتری فعال:</strong> ${customerData.customer.firstName} ${customerData.customer.lastName}</p>
                            <div style="background: #3b82f6; color: white; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                🛒 به صفحه Shop بروید و سفارش ثبت کنید
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                } else {
                    throw new Error('Customer authentication failed');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        ❌ مشکل در تست چک اوت: ${error.message}
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        // Auto-check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkCurrentAuth, 1000);
        });
    </script>
</body>
</html>