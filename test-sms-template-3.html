<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Template ID 3 Ø¨Ø±Ø§ÛŒ Ú©Ø¯ ØªØ­ÙˆÛŒÙ„</title>
    <style>
        body {
            font-family: 'Vazir', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
            direction: rtl;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #2563eb;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8fafc;
        }
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            font-family: inherit;
        }
        .button:hover {
            opacity: 0.9;
        }
        .log-section {
            background-color: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            white-space: pre-wrap;
            direction: ltr;
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .template-display {
            background: #e0f2fe;
            border: 1px solid #0284c7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            direction: rtl;
        }
        .template-content {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            direction: rtl;
            white-space: pre-line;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸ”§ ØªØ³Øª Template ID 3 Ø¨Ø±Ø§ÛŒ Ú©Ø¯ ØªØ­ÙˆÛŒÙ„ Ø³ÙØ§Ø±Ø´</h1>
            <p>ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ ØµØ­ÛŒØ­ template Ø´Ù…Ø§Ø±Ù‡ 3 Ù¾Ø³ Ø§Ø² ØªØµØ­ÛŒØ­ backend</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ Template Ø´Ù…Ø§Ø±Ù‡ 3 (ØµØ­ÛŒØ­):</h3>
            <div class="template-display">
                <strong>Template ID:</strong> 3<br>
                <strong>Category ID:</strong> 2<br>
                <strong>Ù…Ø­ØªÙˆØ§ÛŒ Template:</strong>
                <div class="template-content">
Ø³Ù„Ø§Ù… {{customer_name}}
Ú©Ø¯ ØªØ­ÙˆÛŒÙ„ Ø³ÙØ§Ø±Ø´ {{order_number}}: {{delivery_code}}
Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù„Ø§ Ø¨Ù‡ Ù¾ÛŒÚ© Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.
Ù…Ù…ØªØ§Ø² Ø´ÛŒÙ…ÛŒ
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯:</h3>
            <p>Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ±ØŒ Ø³ÙØ§Ø±Ø´ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø§Ø² warehouse Ø¨Ù‡ logistics Ù…Ù†ØªÙ‚Ù„ Ø´Ø¯Ù‡ Ùˆ SMS Ú©Ø¯ ØªØ­ÙˆÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯:</p>
            
            <button class="button" onclick="testOrderStatusChange()">
                ØªØ³Øª ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ùˆ Ø§Ø±Ø³Ø§Ù„ SMS
            </button>
            
            <button class="button" onclick="checkTemplateDatabase()">
                Ø¨Ø±Ø±Ø³ÛŒ Templates Ø¯Ø± Database
            </button>
            
            <button class="button" onclick="clearLog()">
                Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯
            </button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ Ù†ØªØ§ÛŒØ¬ ØªØ³Øª:</h3>
            <div id="log" class="log-section">
Ù…Ù†ØªØ¸Ø± ØªØ³Øª...
            </div>
        </div>
    </div>

    <script>
        const log = document.getElementById('log');

        function appendLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const colorClass = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            log.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            log.innerHTML = 'Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯...\n';
        }

        async function checkTemplateDatabase() {
            appendLog('ğŸ” Ø¨Ø±Ø±Ø³ÛŒ templates Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± database...', 'info');
            
            try {
                const response = await fetch('/api/sms/templates');
                const data = await response.json();
                
                if (data.success) {
                    appendLog(`âœ… ØªØ¹Ø¯Ø§Ø¯ templates ÛŒØ§ÙØª Ø´Ø¯Ù‡: ${data.templates.length}`, 'success');
                    
                    const deliveryCodeTemplates = data.templates.filter(t => 
                        t.name.includes('Ú©Ø¯ ØªØ­ÙˆÛŒÙ„') || t.description.includes('Ú©Ø¯ ØªØ­ÙˆÛŒÙ„')
                    );
                    
                    appendLog(`ğŸ“‹ Templates Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ú©Ø¯ ØªØ­ÙˆÛŒÙ„:`, 'info');
                    deliveryCodeTemplates.forEach(template => {
                        appendLog(`  - Template ID ${template.id}: ${template.name}`, 'info');
                        appendLog(`    Category: ${template.categoryId}, Content: ${template.content.substring(0, 50)}...`, 'info');
                    });
                    
                    if (deliveryCodeTemplates.find(t => t.id === 3)) {
                        appendLog('âœ… Template ID 3 Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª', 'success');
                    } else {
                        appendLog('âŒ Template ID 3 ÛŒØ§ÙØª Ù†Ø´Ø¯!', 'error');
                    }
                    
                } else {
                    appendLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª templates: ${data.message}`, 'error');
                }
            } catch (error) {
                appendLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ API: ${error.message}`, 'error');
            }
        }

        async function testOrderStatusChange() {
            appendLog('ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ³Øª ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´...', 'info');
            
            try {
                // Ø§Ø¨ØªØ¯Ø§ Ø³ÙØ§Ø±Ø´Ø§Øª warehouse Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒÙ…
                appendLog('ğŸ“¦ Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª warehouse...', 'info');
                
                const warehouseResponse = await fetch('/api/order-management/warehouse');
                const warehouseData = await warehouseResponse.json();
                
                if (!warehouseData.success || warehouseData.orders.length === 0) {
                    appendLog('âŒ Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ Ø¯Ø± warehouse ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                    return;
                }
                
                // Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÙˆÙ„ÛŒÙ† Ø³ÙØ§Ø±Ø´ Ø¨Ø±Ø§ÛŒ ØªØ³Øª
                const testOrder = warehouseData.orders[0];
                appendLog(`ğŸ“‹ Ø³ÙØ§Ø±Ø´ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: ${testOrder.orderNumber} (Management ID: ${testOrder.id})`, 'info');
                appendLog(`ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: ${testOrder.customer?.firstName || ''} ${testOrder.customer?.lastName || ''}`, 'info');
                appendLog(`ğŸ“ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†: ${testOrder.customer?.phone}`, 'info');
                
                // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ warehouse_approved Ø¨Ø±Ø§ÛŒ ØªØ±ÛŒÚ¯Ø± Ú©Ø±Ø¯Ù† SMS
                appendLog('ğŸ”„ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ warehouse_approved...', 'info');
                
                const statusChangeResponse = await fetch(`/api/order-management/${testOrder.id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        newStatus: 'warehouse_approved',
                        department: 'warehouse',
                        changedBy: 1,
                        notes: 'ØªØ³Øª Ø§Ø±Ø³Ø§Ù„ SMS Ú©Ø¯ ØªØ­ÙˆÛŒÙ„ Ø¨Ø§ template Ø´Ù…Ø§Ø±Ù‡ 3'
                    })
                });
                
                const statusResult = await statusChangeResponse.json();
                
                if (statusResult.success) {
                    appendLog('âœ… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ ØªØºÛŒÛŒØ± ÛŒØ§ÙØª', 'success');
                    appendLog('ğŸ“± SMS Ú©Ø¯ ØªØ­ÙˆÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯...', 'success');
                    appendLog(`ğŸ”¢ Ú©Ø¯ ØªØ­ÙˆÛŒÙ„ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡: ${statusResult.deliveryCode || 'Ù†Ø§Ù…Ø´Ø®Øµ'}`, 'info');
                    
                    // Ù…Ù†ØªØ¸Ø± Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§Ø´ÛŒÙ… ØªØ§ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ± Ø¸Ø§Ù‡Ø± Ø´ÙˆÙ†Ø¯
                    appendLog('â³ Ù…Ù†ØªØ¸Ø± Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ±...', 'info');
                    setTimeout(() => {
                        appendLog('â„¹ï¸ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ SMS Ø±Ø§ Ø¯Ø± console Ø³Ø±ÙˆØ± Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯', 'info');
                        appendLog('ğŸ” Ø¨Ø§ÛŒØ¯ Ù¾ÛŒØ§Ù… "ğŸ“± [SMS TEMPLATE 3]" Ø¯Ø± Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø¨Ø§Ø´Ø¯', 'info');
                    }, 2000);
                    
                } else {
                    appendLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª: ${statusResult.message}`, 'error');
                }
                
            } catch (error) {
                appendLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª: ${error.message}`, 'error');
            }
        }

        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ templates
        window.onload = function() {
            appendLog('ğŸ”§ ØµÙØ­Ù‡ ØªØ³Øª Template ID 3 Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯', 'success');
            appendLog('ğŸ’¡ ØªÙˆØ¶ÛŒØ­: backend Ø§Ú©Ù†ÙˆÙ† Ø§Ø² template ID 3 Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¨Ø¬Ø§ÛŒ template ID 1', 'info');
            checkTemplateDatabase();
        };
    </script>
</body>
</html>