<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست مشکل سابمیت فرم چک اوت</title>
    <style>
        body {
            font-family: 'Tahoma', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em;
        }
        .error-banner {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-result {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            min-height: 60px;
        }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        .warning { border-color: #f59e0b; background: #fffbeb; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .issue-list {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: right;
        }
        .solution-list {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐛 تشخیص مشکل سابمیت فرم چک اوت</h1>
        
        <div class="error-banner">
            <h2>❌ کارت چک اوت سابمیت نمی‌شود</h2>
            <p>بررسی دلایل احتمالی عدم کارکرد فرم چک اوت</p>
        </div>

        <div class="issue-list">
            <h3>🔍 دلایل احتمالی عدم سابمیت:</h3>
            <ul>
                <li>✅ نبود انتخاب روش تحویل (Shipping Method)</li>
                <li>✅ خطاهای اعتبارسنجی فرم (Form Validation)</li>
                <li>✅ مشکل در احراز هویت مشتری</li>
                <li>✅ خطای API در سابمیت سفارش</li>
                <li>✅ مشکل در محاسبه VAT یا مالیات</li>
                <li>✅ خطا در داده‌های ولت (Wallet)</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🧪 تست 1: بررسی روش‌های تحویل</h3>
            <button onclick="checkDeliveryMethods()">بررسی در دسترس بودن روش‌های تحویل</button>
            <div id="deliveryResult" class="test-result">
                کلیک کنید تا روش‌های تحویل بررسی شود...
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 تست 2: بررسی احراز هویت مشتری</h3>
            <button onclick="checkCustomerAuth()">بررسی وضعیت احراز هویت</button>
            <div id="authResult" class="test-result">
                کلیک کنید تا احراز هویت بررسی شود...
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 تست 3: بررسی تنظیمات مالیات</h3>
            <button onclick="checkTaxSettings()">بررسی VAT و مالیات</button>
            <div id="taxResult" class="test-result">
                کلیک کنید تا تنظیمات مالیاتی بررسی شود...
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 تست 4: شبیه‌سازی سابمیت فرم</h3>
            <button onclick="simulateFormSubmit()">شبیه‌سازی سابمیت با داده‌های نمونه</button>
            <div id="submitResult" class="test-result">
                کلیک کنید تا سابمیت شبیه‌سازی شود...
            </div>
        </div>

        <div class="solution-list">
            <h3>💡 راه‌حل‌های احتمالی:</h3>
            <ul>
                <li>✅ بررسی انتخاب روش تحویل قبل از سابمیت</li>
                <li>✅ نمایش خطاهای اعتبارسنجی فرم</li>
                <li>✅ رفع مشکل احراز هویت</li>
                <li>✅ بررسی API endpoint سابمیت سفارش</li>
                <li>✅ تست با console.log برای دیباگ</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 30px; color: #4a5568;">
            <p><strong>وضعیت:</strong> در حال تشخیص مشکل...</p>
        </div>
    </div>

    <script>
        async function checkDeliveryMethods() {
            const resultEl = document.getElementById('deliveryResult');
            resultEl.innerHTML = 'در حال بررسی روش‌های تحویل...';
            
            try {
                const response = await fetch('/api/checkout/delivery-methods');
                const data = await response.json();
                
                if (response.ok && Array.isArray(data)) {
                    const smartVehicle = data.find(m => m.value === 'smart_vehicle');
                    const selfPickup = data.find(m => m.value === 'self_pickup');
                    
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <h4>🚚 روش‌های تحویل:</h4>
                            ${smartVehicle ? `
                                <div style="background: #10b981; color: white; padding: 8px; border-radius: 4px; margin: 5px 0;">
                                    ✅ ${smartVehicle.label} - ID: ${smartVehicle.id}
                                </div>
                            ` : ''}
                            ${selfPickup ? `
                                <div style="background: #3b82f6; color: white; padding: 8px; border-radius: 4px; margin: 5px 0;">
                                    ✅ ${selfPickup.label} - ID: ${selfPickup.id}
                                </div>
                            ` : ''}
                            <p><strong>تعداد کل:</strong> ${data.length} روش</p>
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                ✅ روش‌های تحویل در دسترس هستند
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                } else {
                    throw new Error('Invalid delivery methods response');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        ❌ خطا در بارگذاری روش‌های تحویل: ${error.message}
                        <p>احتمالاً این مشکل اصلی باشد!</p>
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        async function checkCustomerAuth() {
            const resultEl = document.getElementById('authResult');
            resultEl.innerHTML = 'در حال بررسی احراز هویت...';
            
            try {
                const response = await fetch('/api/customers/me', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <h4>🔐 وضعیت احراز هویت:</h4>
                            <p><strong>مشتری:</strong> ${data.customer.firstName} ${data.customer.lastName}</p>
                            <p><strong>ایمیل:</strong> ${data.customer.email}</p>
                            <p><strong>آدرس:</strong> ${data.customer.address || 'ثبت نشده'}</p>
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                ✅ مشتری وارد شده است
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                } else {
                    throw new Error(data.message || 'Authentication failed');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        ❌ مشتری وارد نشده: ${error.message}
                        <p>احتمالاً نیاز به ورود مجدد دارید</p>
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        async function checkTaxSettings() {
            const resultEl = document.getElementById('taxResult');
            resultEl.innerHTML = 'در حال بررسی تنظیمات مالیاتی...';
            
            try {
                const response = await fetch('/api/tax-settings');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const vatSetting = data.data.find(s => (s.type === 'VAT' || s.type === 'vat') && s.isEnabled);
                    const dutiesSetting = data.data.find(s => s.type === 'duties' && s.isEnabled);
                    
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <h4>💰 تنظیمات مالیاتی:</h4>
                            <p><strong>VAT:</strong> ${vatSetting ? `فعال (${vatSetting.rate}%)` : 'غیرفعال'}</p>
                            <p><strong>عوارض:</strong> ${dutiesSetting ? `فعال (${dutiesSetting.rate}%)` : 'غیرفعال'}</p>
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                ✅ تنظیمات مالیاتی بارگذاری شد
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                } else {
                    throw new Error('Tax settings failed');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        ❌ خطا در تنظیمات مالیاتی: ${error.message}
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        async function simulateFormSubmit() {
            const resultEl = document.getElementById('submitResult');
            resultEl.innerHTML = 'در حال شبیه‌سازی سابمیت...';
            
            // Sample order data (similar to what the form would send)
            const sampleOrderData = {
                customerName: "تست کاربر",
                phone: "09123456789",
                address: "آدرس تست",
                city: "بغداد",
                country: "Iraq",
                postalCode: "12345",
                notes: "تست سفارش",
                cart: {
                    "475": 1  // Sample product
                },
                totalAmount: 50000,
                subtotalAmount: 45000,
                shippingCost: 5000,
                vatAmount: 0,
                selectedShippingMethod: 7, // Smart vehicle
                currency: 'IQD',
                paymentMethod: 'online_payment',
                walletAmountUsed: 0,
                remainingAmount: 50000
            };
            
            try {
                const response = await fetch('/api/customers/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(sampleOrderData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <h4>✅ سابمیت موفق:</h4>
                            <p><strong>شناسه سفارش:</strong> ${data.orderId || 'نامشخص'}</p>
                            <p><strong>پیام:</strong> ${data.message || 'سفارش ثبت شد'}</p>
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                ✅ API سابمیت سفارش کار می‌کند!
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                } else {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        ❌ خطا در سابمیت: ${error.message}
                        <p>این احتمالاً دلیل اصلی مشکل است!</p>
                        <div style="background: #fbbf24; color: #92400e; padding: 8px; border-radius: 4px; margin-top: 8px;">
                            💡 بررسی کنید: آیا مشتری وارد شده؟ آیا روش تحویل انتخاب شده؟
                        </div>
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        // Auto-run basic checks on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkDeliveryMethods();
                setTimeout(() => {
                    checkCustomerAuth();
                }, 1000);
                setTimeout(() => {
                    checkTaxSettings();
                }, 2000);
            }, 500);
        });
    </script>
</body>
</html>