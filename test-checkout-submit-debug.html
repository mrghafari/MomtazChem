<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ù…Ø´Ú©Ù„ Ø³Ø§Ø¨Ù…ÛŒØª ÙØ±Ù… Ú†Ú© Ø§ÙˆØª</title>
    <style>
        body {
            font-family: 'Tahoma', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em;
        }
        .error-banner {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-result {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            min-height: 60px;
        }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        .warning { border-color: #f59e0b; background: #fffbeb; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .issue-list {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: right;
        }
        .solution-list {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ØªØ´Ø®ÛŒØµ Ù…Ø´Ú©Ù„ Ø³Ø§Ø¨Ù…ÛŒØª ÙØ±Ù… Ú†Ú© Ø§ÙˆØª</h1>
        
        <div class="error-banner">
            <h2>âŒ Ú©Ø§Ø±Øª Ú†Ú© Ø§ÙˆØª Ø³Ø§Ø¨Ù…ÛŒØª Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯</h2>
            <p>Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù„Ø§ÛŒÙ„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø¹Ø¯Ù… Ú©Ø§Ø±Ú©Ø±Ø¯ ÙØ±Ù… Ú†Ú© Ø§ÙˆØª</p>
        </div>

        <div class="issue-list">
            <h3>ğŸ” Ø¯Ù„Ø§ÛŒÙ„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø¹Ø¯Ù… Ø³Ø§Ø¨Ù…ÛŒØª:</h3>
            <ul>
                <li>âœ… Ù†Ø¨ÙˆØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ ØªØ­ÙˆÛŒÙ„ (Shipping Method)</li>
                <li>âœ… Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ±Ù… (Form Validation)</li>
                <li>âœ… Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù…Ø´ØªØ±ÛŒ</li>
                <li>âœ… Ø®Ø·Ø§ÛŒ API Ø¯Ø± Ø³Ø§Ø¨Ù…ÛŒØª Ø³ÙØ§Ø±Ø´</li>
                <li>âœ… Ù…Ø´Ú©Ù„ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ VAT ÛŒØ§ Ù…Ø§Ù„ÛŒØ§Øª</li>
                <li>âœ… Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆÙ„Øª (Wallet)</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª ØªØ³Øª 1: Ø¨Ø±Ø±Ø³ÛŒ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ ØªØ­ÙˆÛŒÙ„</h3>
            <button onclick="checkDeliveryMethods()">Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø¨ÙˆØ¯Ù† Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ ØªØ­ÙˆÛŒÙ„</button>
            <div id="deliveryResult" class="test-result">
                Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ ØªØ­ÙˆÛŒÙ„ Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯...
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª ØªØ³Øª 2: Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù…Ø´ØªØ±ÛŒ</h3>
            <button onclick="checkCustomerAuth()">Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª</button>
            <div id="authResult" class="test-result">
                Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯...
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª ØªØ³Øª 3: Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø§Ù„ÛŒØ§Øª</h3>
            <button onclick="checkTaxSettings()">Ø¨Ø±Ø±Ø³ÛŒ VAT Ùˆ Ù…Ø§Ù„ÛŒØ§Øª</button>
            <div id="taxResult" class="test-result">
                Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø§Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯...
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª ØªØ³Øª 4: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¨Ù…ÛŒØª ÙØ±Ù…</h3>
            <button onclick="simulateFormSubmit()">Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¨Ù…ÛŒØª Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡</button>
            <div id="submitResult" class="test-result">
                Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ø³Ø§Ø¨Ù…ÛŒØª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´ÙˆØ¯...
            </div>
        </div>

        <div class="solution-list">
            <h3>ğŸ’¡ Ø±Ø§Ù‡â€ŒØ­Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ:</h3>
            <ul>
                <li>âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ ØªØ­ÙˆÛŒÙ„ Ù‚Ø¨Ù„ Ø§Ø² Ø³Ø§Ø¨Ù…ÛŒØª</li>
                <li>âœ… Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ±Ù…</li>
                <li>âœ… Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª</li>
                <li>âœ… Ø¨Ø±Ø±Ø³ÛŒ API endpoint Ø³Ø§Ø¨Ù…ÛŒØª Ø³ÙØ§Ø±Ø´</li>
                <li>âœ… ØªØ³Øª Ø¨Ø§ console.log Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 30px; color: #4a5568;">
            <p><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> Ø¯Ø± Ø­Ø§Ù„ ØªØ´Ø®ÛŒØµ Ù…Ø´Ú©Ù„...</p>
        </div>
    </div>

    <script>
        async function checkDeliveryMethods() {
            const resultEl = document.getElementById('deliveryResult');
            resultEl.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ ØªØ­ÙˆÛŒÙ„...';
            
            try {
                const response = await fetch('/api/checkout/delivery-methods');
                const data = await response.json();
                
                if (response.ok && Array.isArray(data)) {
                    const smartVehicle = data.find(m => m.value === 'smart_vehicle');
                    const selfPickup = data.find(m => m.value === 'self_pickup');
                    
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <h4>ğŸšš Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ ØªØ­ÙˆÛŒÙ„:</h4>
                            ${smartVehicle ? `
                                <div style="background: #10b981; color: white; padding: 8px; border-radius: 4px; margin: 5px 0;">
                                    âœ… ${smartVehicle.label} - ID: ${smartVehicle.id}
                                </div>
                            ` : ''}
                            ${selfPickup ? `
                                <div style="background: #3b82f6; color: white; padding: 8px; border-radius: 4px; margin: 5px 0;">
                                    âœ… ${selfPickup.label} - ID: ${selfPickup.id}
                                </div>
                            ` : ''}
                            <p><strong>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„:</strong> ${data.length} Ø±ÙˆØ´</p>
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                âœ… Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ ØªØ­ÙˆÛŒÙ„ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù‡Ø³ØªÙ†Ø¯
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                } else {
                    throw new Error('Invalid delivery methods response');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ ØªØ­ÙˆÛŒÙ„: ${error.message}
                        <p>Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø§ÛŒÙ† Ù…Ø´Ú©Ù„ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø´Ø¯!</p>
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        async function checkCustomerAuth() {
            const resultEl = document.getElementById('authResult');
            resultEl.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª...';
            
            try {
                const response = await fetch('/api/customers/me', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <h4>ğŸ” ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª:</h4>
                            <p><strong>Ù…Ø´ØªØ±ÛŒ:</strong> ${data.customer.firstName} ${data.customer.lastName}</p>
                            <p><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> ${data.customer.email}</p>
                            <p><strong>Ø¢Ø¯Ø±Ø³:</strong> ${data.customer.address || 'Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡'}</p>
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                âœ… Ù…Ø´ØªØ±ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø§Ø³Øª
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                } else {
                    throw new Error(data.message || 'Authentication failed');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        âŒ Ù…Ø´ØªØ±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡: ${error.message}
                        <p>Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø±ÛŒØ¯</p>
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        async function checkTaxSettings() {
            const resultEl = document.getElementById('taxResult');
            resultEl.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø§Ù„ÛŒØ§ØªÛŒ...';
            
            try {
                const response = await fetch('/api/tax-settings');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const vatSetting = data.data.find(s => (s.type === 'VAT' || s.type === 'vat') && s.isEnabled);
                    const dutiesSetting = data.data.find(s => s.type === 'duties' && s.isEnabled);
                    
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <h4>ğŸ’° ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø§Ù„ÛŒØ§ØªÛŒ:</h4>
                            <p><strong>VAT:</strong> ${vatSetting ? `ÙØ¹Ø§Ù„ (${vatSetting.rate}%)` : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}</p>
                            <p><strong>Ø¹ÙˆØ§Ø±Ø¶:</strong> ${dutiesSetting ? `ÙØ¹Ø§Ù„ (${dutiesSetting.rate}%)` : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}</p>
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø§Ù„ÛŒØ§ØªÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                } else {
                    throw new Error('Tax settings failed');
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø§Ù„ÛŒØ§ØªÛŒ: ${error.message}
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        async function simulateFormSubmit() {
            const resultEl = document.getElementById('submitResult');
            resultEl.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¨Ù…ÛŒØª...';
            
            // Sample order data (similar to what the form would send)
            const sampleOrderData = {
                customerName: "ØªØ³Øª Ú©Ø§Ø±Ø¨Ø±",
                phone: "09123456789",
                address: "Ø¢Ø¯Ø±Ø³ ØªØ³Øª",
                city: "Ø¨ØºØ¯Ø§Ø¯",
                country: "Iraq",
                postalCode: "12345",
                notes: "ØªØ³Øª Ø³ÙØ§Ø±Ø´",
                cart: {
                    "475": 1  // Sample product
                },
                totalAmount: 50000,
                subtotalAmount: 45000,
                shippingCost: 5000,
                vatAmount: 0,
                selectedShippingMethod: 7, // Smart vehicle
                currency: 'IQD',
                paymentMethod: 'online_payment',
                walletAmountUsed: 0,
                remainingAmount: 50000
            };
            
            try {
                const response = await fetch('/api/customers/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(sampleOrderData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultEl.innerHTML = `
                        <div style="text-align: right;">
                            <h4>âœ… Ø³Ø§Ø¨Ù…ÛŒØª Ù…ÙˆÙÙ‚:</h4>
                            <p><strong>Ø´Ù†Ø§Ø³Ù‡ Ø³ÙØ§Ø±Ø´:</strong> ${data.orderId || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                            <p><strong>Ù¾ÛŒØ§Ù…:</strong> ${data.message || 'Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ø´Ø¯'}</p>
                            <div style="background: #10b981; color: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                âœ… API Ø³Ø§Ø¨Ù…ÛŒØª Ø³ÙØ§Ø±Ø´ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯!
                            </div>
                        </div>
                    `;
                    resultEl.className = 'test-result success';
                } else {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div style="color: #ef4444;">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø¨Ù…ÛŒØª: ${error.message}
                        <p>Ø§ÛŒÙ† Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø¯Ù„ÛŒÙ„ Ø§ØµÙ„ÛŒ Ù…Ø´Ú©Ù„ Ø§Ø³Øª!</p>
                        <div style="background: #fbbf24; color: #92400e; padding: 8px; border-radius: 4px; margin-top: 8px;">
                            ğŸ’¡ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯: Ø¢ÛŒØ§ Ù…Ø´ØªØ±ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ØŸ Ø¢ÛŒØ§ Ø±ÙˆØ´ ØªØ­ÙˆÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ØŸ
                        </div>
                    </div>
                `;
                resultEl.className = 'test-result error';
            }
        }

        // Auto-run basic checks on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                checkDeliveryMethods();
                setTimeout(() => {
                    checkCustomerAuth();
                }, 1000);
                setTimeout(() => {
                    checkTaxSettings();
                }, 2000);
            }, 500);
        });
    </script>
</body>
</html>