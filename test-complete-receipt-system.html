<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø³ÛŒØ³ØªÙ… Ú©Ø§Ù…Ù„ Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ø¨Ø§Ù†Ú©ÛŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Tahoma', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">ØªØ³Øª Ø³ÛŒØ³ØªÙ… Ú©Ø§Ù…Ù„ Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ø¨Ø§Ù†Ú©ÛŒ</h1>
        
        <!-- Customer Login -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">1. ÙˆØ±ÙˆØ¯ Ù…Ø´ØªØ±ÛŒ</h2>
            <div class="flex gap-4">
                <input type="text" id="customerId" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ù…Ø´ØªØ±ÛŒ (Ù…Ø«Ù„Ø§Ù‹ 8)" class="border p-2 rounded flex-1">
                <button onclick="loginCustomer()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                    ÙˆØ±ÙˆØ¯
                </button>
            </div>
        </div>

        <!-- Customer Info Display -->
        <div id="customerInfo" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ</h2>
            <div id="customerDetails"></div>
        </div>

        <!-- Order Selection -->
        <div id="orderSelection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">2. Ø§Ù†ØªØ®Ø§Ø¨ Ø³ÙØ§Ø±Ø´</h2>
            <div id="ordersList"></div>
        </div>

        <!-- Receipt Upload Test -->
        <div id="receiptUpload" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">3. Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ø¨Ø§Ù†Ú©ÛŒ</h2>
            
            <!-- Order Debt Display -->
            <div id="orderDebtInfo" class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4"></div>
            
            <!-- Receipt Amount Input with Side-by-Side Display -->
            <div class="flex gap-4 mb-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium mb-2">Ù…Ø¨Ù„Øº ÙÛŒØ´ Ø¨Ø§Ù†Ú©ÛŒ (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
                    <input type="number" id="receiptAmount" placeholder="Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ Ø¨Ù‡ Ø¯ÛŒÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÛŒ" 
                           class="w-full border p-3 rounded" onchange="validateAmount()">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium mb-2">Ù…Ø¨Ù„Øº Ø¨Ø¯Ù‡ÛŒ Ø³ÙØ§Ø±Ø´</label>
                    <div id="debtAmountDisplay" class="p-3 bg-orange-50 border border-orange-200 rounded text-center">
                        <div class="text-2xl font-bold text-orange-800" id="debtAmount">-</div>
                        <div class="text-xs text-orange-600">Ø¯ÛŒÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÛŒ</div>
                    </div>
                </div>
            </div>
            
            <!-- Validation Feedback -->
            <div id="validationFeedback" class="mb-4"></div>
            
            <!-- File Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ ÙÛŒØ´</label>
                <input type="file" id="receiptFile" accept="image/*,.pdf" class="w-full border p-2 rounded">
            </div>
            
            <!-- Upload Button -->
            <button onclick="uploadReceipt()" id="uploadBtn" disabled 
                    class="w-full bg-gray-400 text-white py-3 rounded font-medium">
                Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ø¨Ø§Ù†Ú©ÛŒ
            </button>
        </div>

        <!-- Test Scenarios -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ ØªØ³Øª</h2>
            <div class="grid md:grid-cols-3 gap-4">
                <button onclick="testScenario('overpayment')" class="bg-green-500 text-white p-3 rounded hover:bg-green-600">
                    ØªØ³Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø¶Ø§ÙÛŒ<br>
                    <small>(Ù…Ø¨Ù„Øº > Ø¨Ø¯Ù‡ÛŒ)</small>
                </button>
                <button onclick="testScenario('exact')" class="bg-blue-500 text-white p-3 rounded hover:bg-blue-600">
                    ØªØ³Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ù‚ÛŒÙ‚<br>
                    <small>(Ù…Ø¨Ù„Øº = Ø¨Ø¯Ù‡ÛŒ)</small>
                </button>
                <button onclick="testScenario('underpayment_covered')" class="bg-yellow-500 text-white p-3 rounded hover:bg-yellow-600">
                    ØªØ³Øª Ú©Ù…Ø¨ÙˆØ¯ Ø¨Ø§ Ù¾ÙˆØ´Ø´ ÙˆØ§Ù„Øª<br>
                    <small>(Ù…Ø¨Ù„Øº < Ø¨Ø¯Ù‡ÛŒ + ÙˆØ§Ù„Øª Ú©Ø§ÙÛŒ)</small>
                </button>
                <button onclick="testScenario('underpayment_insufficient')" class="bg-orange-500 text-white p-3 rounded hover:bg-orange-600">
                    ØªØ³Øª Ú©Ù…Ø¨ÙˆØ¯ Ø¨Ø¯ÙˆÙ† Ù¾ÙˆØ´Ø´<br>
                    <small>(Ù…Ø¨Ù„Øº + ÙˆØ§Ù„Øª < Ø¨Ø¯Ù‡ÛŒ)</small>
                </button>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Ù†ØªØ§ÛŒØ¬ ØªØ³Øª</h2>
            <div id="resultsList"></div>
        </div>
    </div>

    <script>
        let currentCustomer = null;
        let currentOrder = null;
        let customerOrders = [];

        async function loginCustomer() {
            const customerId = document.getElementById('customerId').value;
            if (!customerId) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ù…Ø´ØªØ±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                // Login customer
                const loginResponse = await fetch('/api/customers/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: `customer${customerId}`, 
                        password: 'password123' 
                    })
                });

                if (!loginResponse.ok) {
                    throw new Error('ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚');
                }

                // Get customer info
                const customerResponse = await fetch('/api/customers/me');
                const customerData = await customerResponse.json();
                currentCustomer = customerData.customer;

                // Get customer orders
                const ordersResponse = await fetch('/api/customers/orders');
                const ordersData = await ordersResponse.json();
                customerOrders = ordersData.orders || [];

                displayCustomerInfo();
                displayOrders();

            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯:', error);
                addResult(`Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ù…Ø´ØªØ±ÛŒ ${customerId}: ${error.message}`, 'error');
            }
        }

        function displayCustomerInfo() {
            const customerInfo = document.getElementById('customerInfo');
            const customerDetails = document.getElementById('customerDetails');
            
            customerDetails.innerHTML = `
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <strong>Ù†Ø§Ù…:</strong> ${currentCustomer.firstName} ${currentCustomer.lastName}<br>
                        <strong>Ø´Ù†Ø§Ø³Ù‡:</strong> ${currentCustomer.id}<br>
                        <strong>Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙˆØ§Ù„Øª:</strong> ${currentCustomer.walletBalance?.toLocaleString() || 0} Ø¯ÛŒÙ†Ø§Ø±
                    </div>
                    <div>
                        <strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> ${currentCustomer.email}<br>
                        <strong>ØªÙ„ÙÙ†:</strong> ${currentCustomer.phone}<br>
                        <strong>ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª:</strong> ${customerOrders.length}
                    </div>
                </div>
            `;
            
            customerInfo.classList.remove('hidden');
        }

        function displayOrders() {
            const orderSelection = document.getElementById('orderSelection');
            const ordersList = document.getElementById('ordersList');
            
            if (customerOrders.length === 0) {
                ordersList.innerHTML = '<p class="text-red-500">Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                return;
            }

            const ordersHtml = customerOrders.map(order => `
                <div class="border p-3 rounded mb-2 cursor-pointer hover:bg-gray-50" onclick="selectOrder('${order.orderNumber}')">
                    <div class="flex justify-between items-center">
                        <div>
                            <strong>Ø³ÙØ§Ø±Ø´:</strong> ${order.orderNumber}<br>
                            <strong>Ù…Ø¨Ù„Øº:</strong> ${parseFloat(order.totalAmount).toLocaleString()} Ø¯ÛŒÙ†Ø§Ø±<br>
                            <strong>ÙˆØ¶Ø¹ÛŒØª:</strong> ${order.status}
                        </div>
                        <div class="text-sm text-gray-600">
                            ${new Date(order.createdAt).toLocaleDateString('fa-IR')}
                        </div>
                    </div>
                </div>
            `).join('');
            
            ordersList.innerHTML = ordersHtml;
            orderSelection.classList.remove('hidden');
        }

        function selectOrder(orderNumber) {
            currentOrder = customerOrders.find(o => o.orderNumber === orderNumber);
            if (!currentOrder) return;

            // Display order debt info
            const orderDebtInfo = document.getElementById('orderDebtInfo');
            orderDebtInfo.innerHTML = `
                <h3 class="font-medium mb-2">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø¯Ù‡ÛŒ Ø³ÙØ§Ø±Ø´ ${currentOrder.orderNumber}</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <strong>Ù…Ø¨Ù„Øº Ú©Ù„ Ø³ÙØ§Ø±Ø´:</strong><br>
                        <span class="text-2xl font-bold text-orange-800">${parseFloat(currentOrder.totalAmount).toLocaleString()}</span> Ø¯ÛŒÙ†Ø§Ø±
                    </div>
                    <div>
                        <strong>Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙˆØ§Ù„Øª:</strong><br>
                        <span class="text-xl font-bold text-blue-600">${currentCustomer.walletBalance?.toLocaleString() || 0}</span> Ø¯ÛŒÙ†Ø§Ø±
                    </div>
                    <div>
                        <strong>ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª:</strong><br>
                        <span class="text-sm ${currentOrder.paymentStatus === 'paid' ? 'text-green-600' : 'text-red-600'}">${currentOrder.paymentStatus}</span>
                    </div>
                </div>
            `;

            // Update debt amount display
            document.getElementById('debtAmount').textContent = parseFloat(currentOrder.totalAmount).toLocaleString();
            
            document.getElementById('receiptUpload').classList.remove('hidden');
            addResult(`Ø³ÙØ§Ø±Ø´ ${orderNumber} Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ - Ø¨Ø¯Ù‡ÛŒ: ${parseFloat(currentOrder.totalAmount).toLocaleString()} Ø¯ÛŒÙ†Ø§Ø±`, 'info');
        }

        function validateAmount() {
            const receiptAmount = parseFloat(document.getElementById('receiptAmount').value) || 0;
            const orderAmount = parseFloat(currentOrder?.totalAmount || 0);
            const walletBalance = currentCustomer?.walletBalance || 0;
            const uploadBtn = document.getElementById('uploadBtn');
            const validationFeedback = document.getElementById('validationFeedback');
            
            if (!receiptAmount || !currentOrder) {
                validationFeedback.innerHTML = '';
                uploadBtn.disabled = true;
                uploadBtn.className = "w-full bg-gray-400 text-white py-3 rounded font-medium";
                return;
            }

            let feedbackHtml = '';
            let canUpload = false;

            if (receiptAmount >= orderAmount) {
                const excess = receiptAmount - orderAmount;
                if (excess > 0) {
                    feedbackHtml = `<div class="p-3 bg-green-50 border border-green-200 rounded">
                        <p class="text-green-800">âœ… Ù…Ø¨Ù„Øº Ø§Ø¶Ø§ÙÛŒ ${excess.toLocaleString()} Ø¯ÛŒÙ†Ø§Ø± Ø¨Ù‡ ÙˆØ§Ù„Øª Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯</p>
                    </div>`;
                } else {
                    feedbackHtml = `<div class="p-3 bg-green-50 border border-green-200 rounded">
                        <p class="text-green-800">âœ… Ù…Ø¨Ù„Øº Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø§ Ø¨Ø¯Ù‡ÛŒ Ø´Ù…Ø§ Ø§Ø³Øª</p>
                    </div>`;
                }
                canUpload = true;
            } else {
                const deficit = orderAmount - receiptAmount;
                if (walletBalance >= deficit) {
                    feedbackHtml = `<div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-yellow-800">âš ï¸ Ú©Ù…Ø¨ÙˆØ¯ ${deficit.toLocaleString()} Ø¯ÛŒÙ†Ø§Ø± Ø§Ø² ÙˆØ§Ù„Øª Ø´Ù…Ø§ (${walletBalance.toLocaleString()} Ø¯ÛŒÙ†Ø§Ø±) Ú©Ø³Ø± Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯</p>
                    </div>`;
                    canUpload = true;
                } else {
                    feedbackHtml = `<div class="p-3 bg-orange-50 border border-orange-200 rounded">
                        <p class="text-orange-800">âš ï¸ Ú©Ù…Ø¨ÙˆØ¯ ${deficit.toLocaleString()} Ø¯ÛŒÙ†Ø§Ø± - Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙˆØ§Ù„Øª ${walletBalance.toLocaleString()} Ø¯ÛŒÙ†Ø§Ø± Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª</p>
                        <p class="text-sm text-orange-600 mt-1">ÙÛŒØ´ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯</p>
                    </div>`;
                    canUpload = true; // Can still upload for manager approval
                }
            }

            validationFeedback.innerHTML = feedbackHtml;
            
            const fileSelected = document.getElementById('receiptFile').files.length > 0;
            uploadBtn.disabled = !(canUpload && fileSelected && receiptAmount > 0);
            uploadBtn.className = uploadBtn.disabled 
                ? "w-full bg-gray-400 text-white py-3 rounded font-medium"
                : "w-full bg-blue-500 text-white py-3 rounded font-medium hover:bg-blue-600";
        }

        // Enable upload button when file is selected
        document.getElementById('receiptFile').addEventListener('change', validateAmount);

        async function uploadReceipt() {
            const receiptAmount = document.getElementById('receiptAmount').value;
            const receiptFile = document.getElementById('receiptFile').files[0];
            
            if (!receiptAmount || !receiptFile || !currentOrder) {
                alert('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                return;
            }

            const formData = new FormData();
            formData.append('receipt', receiptFile);
            formData.append('orderId', currentOrder.orderNumber);
            formData.append('amount', receiptAmount);
            formData.append('notes', 'ØªØ³Øª Ø¢Ù¾Ù„ÙˆØ¯ Ø³ÛŒØ³ØªÙ…');

            try {
                const response = await fetch('/api/payment/upload-receipt', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    addResult(`âœ… Ø¢Ù¾Ù„ÙˆØ¯ Ù…ÙˆÙÙ‚: ${result.message}`, 'success');
                    addResult(`ğŸ“Š Ø¬Ø²Ø¦ÛŒØ§Øª: Ù…Ø¨Ù„Øº ÙÛŒØ´=${result.data.receiptAmount.toLocaleString()}, Ù…Ø¨Ù„Øº Ø³ÙØ§Ø±Ø´=${result.data.orderAmount.toLocaleString()}, Ø§Ø¶Ø§ÙÛŒ ÙˆØ§Ù„Øª=${result.data.walletCredit || 0}, Ú©Ø³Ø± ÙˆØ§Ù„Øª=${result.data.walletDeduction || 0}`, 'info');
                } else {
                    addResult(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯: ${result.message}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·: ${error.message}`, 'error');
            }
        }

        function testScenario(scenario) {
            if (!currentOrder) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø³ÙØ§Ø±Ø´ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            const orderAmount = parseFloat(currentOrder.totalAmount);
            const walletBalance = currentCustomer?.walletBalance || 0;
            let testAmount;

            switch (scenario) {
                case 'overpayment':
                    testAmount = orderAmount + 50000; // 50,000 excess
                    break;
                case 'exact':
                    testAmount = orderAmount;
                    break;
                case 'underpayment_covered':
                    testAmount = Math.max(orderAmount - Math.min(walletBalance - 10000, 30000), 1000);
                    break;
                case 'underpayment_insufficient':
                    testAmount = Math.max(orderAmount - walletBalance - 50000, 1000);
                    break;
            }

            document.getElementById('receiptAmount').value = testAmount;
            validateAmount();
            
            addResult(`ğŸ§ª ØªØ³Øª Ø³Ù†Ø§Ø±ÛŒÙˆ: ${scenario} - Ù…Ø¨Ù„Øº ØªØ³Øª: ${testAmount.toLocaleString()} Ø¯ÛŒÙ†Ø§Ø±`, 'info');
        }

        function addResult(message, type) {
            const resultsList = document.getElementById('resultsList');
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const colorClass = {
                'success': 'text-green-600 border-green-200 bg-green-50',
                'error': 'text-red-600 border-red-200 bg-red-50',
                'info': 'text-blue-600 border-blue-200 bg-blue-50'
            }[type];
            
            resultsList.innerHTML = `
                <div class="border rounded p-3 mb-2 ${colorClass}">
                    <span class="text-xs text-gray-500">[${timestamp}]</span> ${message}
                </div>
            ` + resultsList.innerHTML;
        }
    </script>
</body>
</html>