<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø± Ø¯Ø± CRM</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 10px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        .test-result { margin-top: 10px; padding: 10px; border-radius: 4px; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ ØªØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø± Ø¯Ø± Ø³ÛŒØ³ØªÙ… CRM</h1>
        <p>Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø± Ùˆ Ø«Ø¨Øª Ø¢Ù† Ø¯Ø± Ø³ÛŒØ³ØªÙ… CRM Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>

        <div class="test-section info">
            <h3>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ø³ÛŒØ³ØªÙ…</h3>
            <div id="systemStatus">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ” ØªØ³Øª 1: Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</h3>
            <button class="btn-primary" onclick="testGetProvinces()">Ø¯Ø±ÛŒØ§ÙØª Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</button>
            <div id="provincesResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ™ï¸ ØªØ³Øª 2: Ø¯Ø±ÛŒØ§ÙØª Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†</h3>
            <select id="provinceSelect">
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù†</option>
            </select>
            <button class="btn-primary" onclick="testGetCities()">Ø¯Ø±ÛŒØ§ÙØª Ø´Ù‡Ø±Ù‡Ø§</button>
            <div id="citiesResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ‘¤ ØªØ³Øª 3: Ø¯Ø±ÛŒØ§ÙØª Ù…Ø´ØªØ±ÛŒ CRM</h3>
            <input type="number" id="customerIdInput" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ù…Ø´ØªØ±ÛŒ" value="8">
            <button class="btn-primary" onclick="testGetCrmCustomer()">Ø¯Ø±ÛŒØ§ÙØª Ù…Ø´ØªØ±ÛŒ</button>
            <div id="customerResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>âœï¸ ØªØ³Øª 4: Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ù‡Ø± Ù…Ø´ØªØ±ÛŒ</h3>
            <div>
                <label>Ø´Ù†Ø§Ø³Ù‡ Ù…Ø´ØªØ±ÛŒ:</label>
                <input type="number" id="updateCustomerId" value="8">
            </div>
            <div>
                <label>Ø§Ø³ØªØ§Ù† Ø¬Ø¯ÛŒØ¯:</label>
                <select id="updateProvinceSelect">
                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù†</option>
                </select>
            </div>
            <div>
                <label>Ø´Ù‡Ø± Ø¬Ø¯ÛŒØ¯:</label>
                <select id="updateCitySelect">
                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±</option>
                </select>
            </div>
            <button class="btn-success" onclick="testUpdateCustomerCity()">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ù‡Ø±</button>
            <div id="updateResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>âœ… ØªØ³Øª 5: ØªØ§ÛŒÛŒØ¯ Ø«Ø¨Øª Ø´Ù‡Ø± (Ø±ÛŒÙØ±Ø´)</h3>
            <button class="btn-primary" onclick="testVerifyUpdate()">Ø¨Ø±Ø±Ø³ÛŒ Ø«Ø¨Øª Ø´Ù‡Ø± Ù¾Ø³ Ø§Ø² Ø±ÛŒÙØ±Ø´</button>
            <div id="verifyResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ Ù†ØªØ§ÛŒØ¬ Ú©Ù„ÛŒ</h3>
            <div id="overallResults">Ù‡Ù†ÙˆØ² ØªØ³ØªÛŒ Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
        </div>
    </div>

    <script>
        let testResults = {
            provinces: false,
            cities: false,
            getCustomer: false,
            updateCity: false,
            verifyUpdate: false
        };

        let provinceData = [];
        let cityData = [];

        function updateOverallResults() {
            const resultsDiv = document.getElementById('overallResults');
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r).length;
            
            resultsDiv.innerHTML = `
                <h4>Ù†ØªØ§ÛŒØ¬: ${passed}/${total} ØªØ³Øª Ù…ÙˆÙÙ‚</h4>
                <ul>
                    <li>Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§: ${testResults.provinces ? 'âœ…' : 'âŒ'}</li>
                    <li>Ø´Ù‡Ø±Ù‡Ø§: ${testResults.cities ? 'âœ…' : 'âŒ'}</li>
                    <li>Ø¯Ø±ÛŒØ§ÙØª Ù…Ø´ØªØ±ÛŒ: ${testResults.getCustomer ? 'âœ…' : 'âŒ'}</li>
                    <li>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ù‡Ø±: ${testResults.updateCity ? 'âœ…' : 'âŒ'}</li>
                    <li>ØªØ§ÛŒÛŒØ¯ Ø«Ø¨Øª: ${testResults.verifyUpdate ? 'âœ…' : 'âŒ'}</li>
                </ul>
            `;
            
            if (passed === total) {
                resultsDiv.className = 'test-result success';
            } else if (passed > 0) {
                resultsDiv.className = 'test-result info';
            } else {
                resultsDiv.className = 'test-result error';
            }
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/logistics/provinces');
                const data = await response.json();
                
                document.getElementById('systemStatus').innerHTML = `
                    <div class="success" style="padding: 10px; border-radius: 4px;">
                        âœ… Ø³ÛŒØ³ØªÙ… Ø¢Ù†Ù„Ø§ÛŒÙ† Ø§Ø³Øª: ${data.data?.length || 0} Ø§Ø³ØªØ§Ù† ÛŒØ§ÙØª Ø´Ø¯
                    </div>
                `;
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = `
                    <div class="error" style="padding: 10px; border-radius: 4px;">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…: ${error.message}
                    </div>
                `;
            }
        }

        async function testGetProvinces() {
            try {
                const response = await fetch('/api/logistics/provinces');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    testResults.provinces = true;
                    provinceData = data.data;
                    
                    // Populate select elements
                    const selects = [document.getElementById('provinceSelect'), document.getElementById('updateProvinceSelect')];
                    selects.forEach(select => {
                        select.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù†</option>';
                        data.data.forEach(province => {
                            const option = document.createElement('option');
                            option.value = province.nameEnglish;
                            option.setAttribute('data-id', province.id);
                            option.textContent = `${province.nameEnglish} / ${province.nameArabic}`;
                            select.appendChild(option);
                        });
                    });
                    
                    document.getElementById('provincesResult').innerHTML = `
                        <div class="success">
                            âœ… Ù…ÙˆÙÙ‚: ${data.data.length} Ø§Ø³ØªØ§Ù† Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯
                            <pre>${JSON.stringify(data.data.slice(0, 3), null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ');
                }
            } catch (error) {
                testResults.provinces = false;
                document.getElementById('provincesResult').innerHTML = `
                    <div class="error">
                        âŒ Ø®Ø·Ø§: ${error.message}
                    </div>
                `;
            }
            updateOverallResults();
        }

        async function testGetCities() {
            try {
                const provinceSelect = document.getElementById('provinceSelect');
                const selectedOption = provinceSelect.options[provinceSelect.selectedIndex];
                
                if (!selectedOption.value) {
                    throw new Error('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                }
                
                const provinceId = selectedOption.getAttribute('data-id');
                const response = await fetch(`/api/logistics/cities?provinceId=${provinceId}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    testResults.cities = true;
                    cityData = data.data;
                    
                    document.getElementById('citiesResult').innerHTML = `
                        <div class="success">
                            âœ… Ù…ÙˆÙÙ‚: ${data.data.length} Ø´Ù‡Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§Ù† ${selectedOption.value} ÛŒØ§ÙØª Ø´Ø¯
                            <pre>${JSON.stringify(data.data.slice(0, 5), null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ');
                }
            } catch (error) {
                testResults.cities = false;
                document.getElementById('citiesResult').innerHTML = `
                    <div class="error">
                        âŒ Ø®Ø·Ø§: ${error.message}
                    </div>
                `;
            }
            updateOverallResults();
        }

        async function testGetCrmCustomer() {
            try {
                const customerId = document.getElementById('customerIdInput').value;
                if (!customerId) {
                    throw new Error('Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ù…Ø´ØªØ±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                }
                
                const response = await fetch(`/api/crm/customers/${customerId}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (response.ok && data.success) {
                    testResults.getCustomer = true;
                    document.getElementById('customerResult').innerHTML = `
                        <div class="success">
                            âœ… Ù…ÙˆÙÙ‚: Ù…Ø´ØªØ±ÛŒ ${data.data.firstName} ${data.data.lastName} ÛŒØ§ÙØª Ø´Ø¯
                            <p><strong>Ø´Ù‡Ø± ÙØ¹Ù„ÛŒ:</strong> ${data.data.cityRegion || 'ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡'}</p>
                            <p><strong>Ø§Ø³ØªØ§Ù† ÙØ¹Ù„ÛŒ:</strong> ${data.data.province || 'ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡'}</p>
                            <pre>${JSON.stringify(data.data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Ù…Ø´ØªØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }
            } catch (error) {
                testResults.getCustomer = false;
                document.getElementById('customerResult').innerHTML = `
                    <div class="error">
                        âŒ Ø®Ø·Ø§: ${error.message}
                    </div>
                `;
            }
            updateOverallResults();
        }

        async function testUpdateCustomerCity() {
            try {
                const customerId = document.getElementById('updateCustomerId').value;
                const province = document.getElementById('updateProvinceSelect').value;
                const city = document.getElementById('updateCitySelect').value;
                
                if (!customerId || !province || !city) {
                    throw new Error('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                }
                
                const updateData = {
                    province: province,
                    cityRegion: city
                };
                
                const response = await fetch(`/api/crm/customers/${customerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    testResults.updateCity = true;
                    document.getElementById('updateResult').innerHTML = `
                        <div class="success">
                            âœ… Ù…ÙˆÙÙ‚: Ø´Ù‡Ø± Ù…Ø´ØªØ±ÛŒ ${customerId} Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯
                            <p><strong>Ø§Ø³ØªØ§Ù† Ø¬Ø¯ÛŒØ¯:</strong> ${data.data.province}</p>
                            <p><strong>Ø´Ù‡Ø± Ø¬Ø¯ÛŒØ¯:</strong> ${data.data.cityRegion}</p>
                            <pre>${JSON.stringify(data.data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ');
                }
            } catch (error) {
                testResults.updateCity = false;
                document.getElementById('updateResult').innerHTML = `
                    <div class="error">
                        âŒ Ø®Ø·Ø§: ${error.message}
                    </div>
                `;
            }
            updateOverallResults();
        }

        async function testVerifyUpdate() {
            try {
                const customerId = document.getElementById('updateCustomerId').value;
                if (!customerId) {
                    throw new Error('Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ù…Ø´ØªØ±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                }
                
                // Clear cache and force fresh request
                const response = await fetch(`/api/crm/customers/${customerId}?_=${Date.now()}`, {
                    credentials: 'include',
                    cache: 'no-cache'
                });
                const data = await response.json();
                
                if (response.ok && data.success) {
                    testResults.verifyUpdate = true;
                    document.getElementById('verifyResult').innerHTML = `
                        <div class="success">
                            âœ… ØªØ§ÛŒÛŒØ¯ Ù…ÙˆÙÙ‚: Ø´Ù‡Ø± Ù…Ø´ØªØ±ÛŒ Ù¾Ø³ Ø§Ø² Ø±ÛŒÙØ±Ø´ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª
                            <p><strong>Ø§Ø³ØªØ§Ù† Ø«Ø¨Øª Ø´Ø¯Ù‡:</strong> ${data.data.province || 'ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡'}</p>
                            <p><strong>Ø´Ù‡Ø± Ø«Ø¨Øª Ø´Ø¯Ù‡:</strong> ${data.data.cityRegion || 'ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡'}</p>
                            <p><strong>ØªØ§Ø±ÛŒØ® Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:</strong> ${data.data.updatedAt}</p>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || 'Ù…Ø´ØªØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }
            } catch (error) {
                testResults.verifyUpdate = false;
                document.getElementById('verifyResult').innerHTML = `
                    <div class="error">
                        âŒ Ø®Ø·Ø§: ${error.message}
                    </div>
                `;
            }
            updateOverallResults();
        }

        // Auto-populate cities when province changes
        document.getElementById('updateProvinceSelect').addEventListener('change', async function() {
            const selectedOption = this.options[this.selectedIndex];
            const citySelect = document.getElementById('updateCitySelect');
            
            if (!selectedOption.value) {
                citySelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±</option>';
                return;
            }
            
            try {
                const provinceId = selectedOption.getAttribute('data-id');
                const response = await fetch(`/api/logistics/cities?provinceId=${provinceId}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    citySelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±</option>';
                    data.data.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.nameEnglish;
                        option.textContent = `${city.nameEnglish} / ${city.nameArabic}`;
                        citySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        });

        // Run system status check on page load
        checkSystemStatus();
        updateOverallResults();
    </script>
</body>
</html>