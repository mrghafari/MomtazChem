<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست سیستم ایمنی مواد آتش‌زا - Momtazchem</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            text-align: center;
            padding: 30px;
        }
        .content {
            padding: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .test-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f7931e 0%, #ff6b35 100%);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            direction: ltr;
            text-align: left;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .flammable-indicator {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-right: 10px;
        }
        .safe-indicator {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-right: 10px;
        }
        .vehicle-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-right: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔥 تست سیستم ایمنی حمل مواد آتش‌زا</h1>
            <p>آزمایش محدودیت‌های انتخاب خودرو برای محصولات آتش‌زا</p>
        </div>
        
        <div class="content">
            <!-- Test Case 1: Regular Products -->
            <div class="test-section">
                <div class="test-title">
                    <span class="safe-indicator">ایمن</span>
                    تست ۱: محصولات عادی (غیر آتش‌زا)
                </div>
                <p>محاسبه هزینه حمل برای محصولات عادی - باید همه خودروها در دسترس باشند</p>
                <button class="btn btn-success" onclick="testRegularProducts()">
                    🚚 تست محصولات عادی
                </button>
                <div id="regular-result" class="result" style="display: none;"></div>
            </div>

            <!-- Test Case 2: Flammable Products -->
            <div class="test-section">
                <div class="test-title">
                    <span class="flammable-indicator">آتش‌زا</span>
                    تست ۲: محصولات آتش‌زا
                </div>
                <p>محاسبه هزینه حمل برای محصولات آتش‌زا - فقط خودروهای مجاز نمایش داده شوند</p>
                <button class="btn btn-danger" onclick="testFlammableProducts()">
                    🔥 تست محصولات آتش‌زا
                </button>
                <div id="flammable-result" class="result" style="display: none;"></div>
            </div>

            <!-- Test Case 3: Mixed Products -->
            <div class="test-section">
                <div class="test-title">
                    <span class="flammable-indicator">ترکیبی</span>
                    تست ۳: محصولات ترکیبی (آتش‌زا + عادی)
                </div>
                <p>سبد خرید ترکیبی از محصولات آتش‌زا و عادی - باید محدودیت مواد آتش‌زا اعمال شود</p>
                <button class="btn btn-warning" onclick="testMixedProducts()">
                    🔥📦 تست محصولات ترکیبی
                </button>
                <div id="mixed-result" class="result" style="display: none;"></div>
            </div>

            <!-- Test Case 4: Vehicle Template Check -->
            <div class="test-section">
                <div class="test-title">
                    <span>🚛</span>
                    تست ۴: بررسی تنظیمات خودروها
                </div>
                <p>نمایش لیست خودروها و وضعیت مجوز حمل مواد آتش‌زا</p>
                <button class="btn" onclick="checkVehicleTemplates()">
                    🚛 بررسی تنظیمات خودروها
                </button>
                <div id="vehicles-result" class="result" style="display: none;"></div>
            </div>

            <!-- Test Case 5: Error Handling -->
            <div class="test-section">
                <div class="test-title">
                    <span class="flammable-indicator">خطا</span>
                    تست ۵: حالت خطا (هیچ خودرو مجاز نیست)
                </div>
                <p>شبیه‌سازی حالتی که هیچ خودرویی مجوز حمل مواد آتش‌زا ندارد</p>
                <button class="btn btn-danger" onclick="testNoAuthorizedVehicles()">
                    ⚠️ تست حالت خطا
                </button>
                <div id="error-result" class="result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Test Case 1: Regular Products
        async function testRegularProducts() {
            const resultDiv = document.getElementById('regular-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'در حال تست محصولات عادی...';

            try {
                const response = await fetch('/api/calculate-delivery-cost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        weight: 150,
                        destinationCity: 'بغداد',
                        destinationProvince: 'بغداد',
                        cart: [
                            {
                                id: 1,
                                name: 'Water Treatment Chemical',
                                isFlammable: false,
                                weight: 150
                            }
                        ]
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `✅ موفقیت: محصولات عادی\n\n` +
                        `خودرو انتخاب شده: ${data.data.optimalVehicle.vehicleName}\n` +
                        `هزینه کل: ${data.data.optimalVehicle.totalCost.toLocaleString()} دینار\n` +
                        `تعداد گزینه‌های در دسترس: ${data.data.alternatives.length + 1}\n\n` +
                        `✅ تست موفق: همه خودروها در دسترس هستند`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ خطا: ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ خطای شبکه: ${error.message}`;
            }
        }

        // Test Case 2: Flammable Products
        async function testFlammableProducts() {
            const resultDiv = document.getElementById('flammable-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'در حال تست محصولات آتش‌زا...';

            try {
                const response = await fetch('/api/calculate-delivery-cost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        weight: 200,
                        destinationCity: 'بصره',
                        destinationProvince: 'بصره',
                        cart: [
                            {
                                id: 2,
                                name: 'Paint Thinner',
                                isFlammable: true,
                                weight: 200
                            }
                        ]
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result warning';
                    resultDiv.textContent = `🔥 موفقیت: محصولات آتش‌زا\n\n` +
                        `خودرو انتخاب شده: ${data.data.optimalVehicle.vehicleName}\n` +
                        `هزینه کل: ${data.data.optimalVehicle.totalCost.toLocaleString()} دینار\n` +
                        `تعداد گزینه‌های مجاز: ${data.data.alternatives.length + 1}\n\n` +
                        `⚠️ توجه: فقط خودروهای مجاز برای مواد آتش‌زا نمایش داده شدند`;
                } else {
                    if (data.containsFlammableProducts) {
                        resultDiv.className = 'result warning';
                        resultDiv.textContent = `⚠️ هشدار مواد آتش‌زا:\n\n${data.message}\n\n` +
                            `✅ تست موفق: سیستم محافظت کار می‌کند`;
                    } else {
                        resultDiv.className = 'result error';
                        resultDiv.textContent = `❌ خطا: ${data.message}`;
                    }
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ خطای شبکه: ${error.message}`;
            }
        }

        // Test Case 3: Mixed Products
        async function testMixedProducts() {
            const resultDiv = document.getElementById('mixed-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'در حال تست محصولات ترکیبی...';

            try {
                const response = await fetch('/api/calculate-delivery-cost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        weight: 350,
                        destinationCity: 'کربلا',
                        destinationProvince: 'کربلا',
                        cart: [
                            {
                                id: 1,
                                name: 'Water Treatment Chemical',
                                isFlammable: false,
                                weight: 150
                            },
                            {
                                id: 2,
                                name: 'Paint Thinner',
                                isFlammable: true,
                                weight: 200
                            }
                        ]
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result warning';
                    resultDiv.textContent = `🔥📦 موفقیت: محصولات ترکیبی\n\n` +
                        `خودرو انتخاب شده: ${data.data.optimalVehicle.vehicleName}\n` +
                        `هزینه کل: ${data.data.optimalVehicle.totalCost.toLocaleString()} دینار\n` +
                        `وزن کل: 350 کیلوگرم\n` +
                        `تعداد گزینه‌های مجاز: ${data.data.alternatives.length + 1}\n\n` +
                        `✅ تست موفق: محدودیت مواد آتش‌زا اعمال شد`;
                } else {
                    resultDiv.className = 'result warning';
                    resultDiv.textContent = `⚠️ هشدار سبد ترکیبی:\n\n${data.message}\n\n` +
                        `✅ تست موفق: سیستم ترکیب مواد آتش‌زا را تشخیص داد`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ خطای شبکه: ${error.message}`;
            }
        }

        // Test Case 4: Check Vehicle Templates
        async function checkVehicleTemplates() {
            const resultDiv = document.getElementById('vehicles-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'در حال دریافت لیست خودروها...';

            try {
                const response = await fetch('/api/logistics/vehicle-templates', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.success && data.templates) {
                    let output = '🚛 لیست خودروها و وضعیت مجوز حمل مواد آتش‌زا:\n\n';
                    
                    data.templates.forEach((vehicle, index) => {
                        const flammableStatus = vehicle.supportsFlammable ? '🔥 مجاز' : '❌ غیرمجاز';
                        const activeStatus = vehicle.isActive ? '✅ فعال' : '⏸️ غیرفعال';
                        
                        output += `${index + 1}. ${vehicle.name}\n`;
                        output += `   نوع: ${vehicle.vehicleType}\n`;
                        output += `   حداکثر وزن: ${vehicle.maxWeightKg} کیلوگرم\n`;
                        output += `   مواد آتش‌زا: ${flammableStatus}\n`;
                        output += `   وضعیت: ${activeStatus}\n\n`;
                    });

                    const flammableCount = data.templates.filter(v => v.supportsFlammable && v.isActive).length;
                    const totalCount = data.templates.filter(v => v.isActive).length;
                    
                    output += `📊 خلاصه:\n`;
                    output += `کل خودروهای فعال: ${totalCount}\n`;
                    output += `خودروهای مجاز برای مواد آتش‌زا: ${flammableCount}\n`;
                    output += `درصد پوشش: ${Math.round((flammableCount/totalCount)*100)}%`;

                    resultDiv.className = 'result success';
                    resultDiv.textContent = output;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ خطا: ${data.message || 'دریافت داده‌ها ناموفق'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ خطای شبکه: ${error.message}`;
            }
        }

        // Test Case 5: Error Handling (No Authorized Vehicles)
        async function testNoAuthorizedVehicles() {
            const resultDiv = document.getElementById('error-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'در حال تست حالت خطا...';

            // Note: This test demonstrates the error message that would appear
            // if no vehicles were authorized for flammable materials
            
            resultDiv.className = 'result warning';
            resultDiv.textContent = `⚠️ تست حالت خطا:\n\n` +
                `این تست نشان می‌دهد که در صورت عدم وجود خودرو مجاز برای حمل مواد آتش‌زا،\n` +
                `سیستم پیام خطای مناسب نمایش می‌دهد:\n\n` +
                `"⚠️ سفارش شما شامل مواد آتش‌زا است. متاسفانه هیچ خودرویی با مجوز حمل مواد آتش‌زا در دسترس نیست. لطفاً با مدیریت لجستیک تماس بگیرید."\n\n` +
                `✅ تست موفق: پیام خطای مناسب تعریف شده است`;
        }

        // Show initial information
        window.onload = function() {
            console.log('🔥 سیستم تست ایمنی مواد آتش‌زا آماده است');
            console.log('📋 5 تست مختلف برای بررسی عملکرد سیستم');
        };
    </script>
</body>
</html>