<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ØªØ³Øª Session Ùˆ Ø«Ø¨Øª Ù†Ø¸Ø±</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .btn {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .btn:hover { background: #2563eb; }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { background: #d1fae5; border-color: #059669; color: #059669; }
        .error { background: #fee2e2; border-color: #dc2626; color: #dc2626; }
        h1 { text-align: center; color: white; margin-bottom: 30px; }
        h2 { color: #333; margin-bottom: 15px; font-size: 18px; }
    </style>
</head>
<body>
    <h1>ğŸ” ØªØ´Ø®ÛŒØµ Ù…Ø´Ú©Ù„ Session Ø¯Ø± Ø«Ø¨Øª Ù†Ø¸Ø±Ø§Øª</h1>

    <div class="card">
        <h2>ğŸ” Ù…Ø±Ø­Ù„Ù‡ 1: ØªØ³Øª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Customer</h2>
        <button class="btn" onclick="testCustomerAuth()">ØªØ³Øª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª</button>
        <div id="authResult" class="result">Ù…Ù†ØªØ¸Ø± ØªØ³Øª...</div>
    </div>

    <div class="card">
        <h2>â­ Ù…Ø±Ø­Ù„Ù‡ 2: Ø«Ø¨Øª Ù†Ø¸Ø± ÙÙˆØ±ÛŒ</h2>
        <button class="btn" onclick="submitTestReview()">Ø«Ø¨Øª Ù†Ø¸Ø±</button>
        <div id="reviewResult" class="result">Ù…Ù†ØªØ¸Ø± Ø«Ø¨Øª Ù†Ø¸Ø±...</div>
    </div>

    <div class="card">
        <h2>ğŸ“ Ù…Ø±Ø­Ù„Ù‡ 3: Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ø¸Ø±Ø§Øª</h2>
        <button class="btn" onclick="checkReviews()">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ø¸Ø±Ø§Øª</button>
        <div id="reviewsResult" class="result">Ù…Ù†ØªØ¸Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø¸Ø±Ø§Øª...</div>
    </div>

    <script>
        async function testCustomerAuth() {
            const div = document.getElementById('authResult');
            try {
                div.className = 'result';
                div.textContent = 'ğŸ”„ ØªØ³Øª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª...\n';
                
                const res = await fetch('/api/customers/me', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await res.json();
                console.log('ğŸ” Customer Auth Response:', data);
                
                if (res.ok && data.success && data.customer) {
                    div.className = 'result success';
                    div.textContent = `âœ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù…ÙˆÙÙ‚!\n\nØ´Ù†Ø§Ø³Ù‡: ${data.customer.id}\nÙ†Ø§Ù…: ${data.customer.firstName} ${data.customer.lastName}\nØ§ÛŒÙ…ÛŒÙ„: ${data.customer.email}\nØªÙ„ÙÙ†: ${data.customer.phone || 'Ù†Ø§Ù…Ø´Ø®Øµ'}\n\nğŸ¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø«Ø¨Øª Ù†Ø¸Ø±!`;
                } else {
                    div.className = 'result error';
                    div.textContent = `âŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù†Ø§Ù…ÙˆÙÙ‚!\n\nÙˆØ¶Ø¹ÛŒØª: ${res.status}\nÙ¾ÛŒØ§Ù…: ${data.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}\n\nÙ„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.`;
                }
            } catch (error) {
                div.className = 'result error'; 
                div.textContent = `âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡!\nØ¬Ø²Ø¦ÛŒØ§Øª: ${error.message}`;
                console.error('Customer auth error:', error);
            }
        }

        async function submitTestReview() {
            const div = document.getElementById('reviewResult');
            try {
                div.className = 'result';
                div.textContent = 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ù†Ø¸Ø±...\n';
                
                const reviewData = {
                    rating: 5,
                    title: 'ØªØ³Øª Ù†Ù‡Ø§ÛŒÛŒ Ø³ÛŒØ³ØªÙ… Ù†Ø¸Ø±Ø§Øª - Customer 8',
                    comment: 'Ø§ÛŒÙ† ÛŒÚ© ØªØ³Øª Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª Ù†Ø¸Ø±Ø§Øª Ø§Ø³Øª. Ø§Ú¯Ø± Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒØ¯ØŒ ÛŒØ¹Ù†ÛŒ Ù…Ø´Ú©Ù„ Ø­Ù„ Ø´Ø¯Ù‡!',
                    review: 'Ø§ÛŒÙ† ÛŒÚ© ØªØ³Øª Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª Ù†Ø¸Ø±Ø§Øª Ø§Ø³Øª. Ø§Ú¯Ø± Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒØ¯ØŒ ÛŒØ¹Ù†ÛŒ Ù…Ø´Ú©Ù„ Ø­Ù„ Ø´Ø¯Ù‡!'
                };
                
                console.log('ğŸ“¤ Review data being sent:', reviewData);
                
                const res = await fetch('/api/products/472/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(reviewData)
                });
                
                const data = await res.json();
                console.log('ğŸ“¨ Review submit response:', data);
                
                if (res.ok && data.success) {
                    div.className = 'result success';
                    div.textContent = `ğŸ‰ Ù†Ø¸Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\n\nØ´Ù†Ø§Ø³Ù‡ Ù†Ø¸Ø±: ${data.data.id}\nØªØ§Ø±ÛŒØ® Ø«Ø¨Øª: ${new Date(data.data.createdAt).toLocaleString('fa-IR')}\nØ§Ù…ØªÛŒØ§Ø²: ${data.data.rating}/5\nØ¹Ù†ÙˆØ§Ù†: ${data.data.title}\n\nÙ¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…: ${data.message}\n\nâœ… Ø³ÛŒØ³ØªÙ… Ù†Ø¸Ø±Ø§Øª Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯!`;
                } else {
                    div.className = 'result error';
                    div.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø¸Ø±!\n\nÚ©Ø¯ Ø®Ø·Ø§: ${res.status}\nÙ¾ÛŒØ§Ù…: ${data.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}\n\nØ¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„:\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                div.className = 'result error';
                div.textContent = `âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø¯Ø± Ø«Ø¨Øª Ù†Ø¸Ø±!\nØ¬Ø²Ø¦ÛŒØ§Øª: ${error.message}`;
                console.error('Review submit error:', error);
            }
        }

        async function checkReviews() {
            const div = document.getElementById('reviewsResult');
            try {
                div.className = 'result';
                div.textContent = 'ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø¸Ø±Ø§Øª...\n';
                
                const res = await fetch('/api/products/472/reviews', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await res.json();
                console.log('ğŸ“‹ Reviews response:', data);
                
                if (res.ok && data.success) {
                    const reviews = data.data.reviews;
                    const stats = data.data.stats;
                    
                    div.className = 'result success';
                    let output = `ğŸ“Š Ù†Ø¸Ø±Ø§Øª Ù…Ø­ØµÙˆÙ„ NPK Fertilizer Complex:\n\n`;
                    output += `Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:\n`;
                    output += `- ØªØ¹Ø¯Ø§Ø¯ Ù†Ø¸Ø±Ø§Øª: ${stats.totalReviews}\n`;
                    output += `- Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²: ${stats.averageRating.toFixed(1)}/5\n\n`;
                    
                    if (reviews.length === 0) {
                        output += `ğŸ“ Ù‡ÛŒÚ† Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.\n`;
                    } else {
                        output += `ğŸ“ Ù†Ø¸Ø±Ø§Øª Ø«Ø¨Øª Ø´Ø¯Ù‡:\n\n`;
                        reviews.forEach((review, index) => {
                            output += `${index + 1}. ${review.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}\n`;
                            output += `   ğŸ‘¤ ${review.customerName}\n`;
                            output += `   â­ ${review.rating}/5\n`;
                            output += `   ğŸ“ ${review.review}\n`;
                            output += `   ğŸ“… ${new Date(review.createdAt).toLocaleString('fa-IR')}\n\n`;
                        });
                    }
                    
                    div.textContent = output;
                } else {
                    div.className = 'result error';
                    div.textContent = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø¸Ø±Ø§Øª!\n\nÚ©Ø¯: ${res.status}\nÙ¾ÛŒØ§Ù…: ${data.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'}`;
                }
            } catch (error) {
                div.className = 'result error';
                div.textContent = `âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡!\nØ¬Ø²Ø¦ÛŒØ§Øª: ${error.message}`;
                console.error('Reviews fetch error:', error);
            }
        }

        // ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Starting authentication test...');
            testCustomerAuth();
        });
    </script>
</body>
</html>